---
import Layout from "./Layout.astro";
import ThemeToggle from "../components/ThemeToggle.astro";
import SidebarNavigation from "../components/SidebarNavigation.astro";

interface Props {
    title: string;
    description?: string;
    meta?: Record<string, string>; // Flexible key-value pairs
    tags?: string[];
    ctaUrl?: string;
    ctaText?: string;
}

const { title, description, meta = {}, tags = [], ctaUrl, ctaText } = Astro.props;

// Convert meta object to array for iteration
const metaEntries = Object.entries(meta).filter(
    ([_, value]) => value && value.trim() !== "",
);

// Standard Sections for Navigation
const sections = [
    { id: "problem-opportunity", label: "Why build it?" },
    { id: "approach", label: "What's the approach?" },
    { id: "interaction-model", label: "How does it work?" },
    { id: "implementation", label: "How is it built?" },
    { id: "outcome", label: "What's the outcome?" },
    { id: "reflection", label: "What I have learned" },
];
---

<Layout title={`${title} | Narayan Ashanahalli`}>
    <!-- LEFT SIDEBAR SLOT -->
    <div slot="sidebar" class="project-sidebar-content">
        <div class="sidebar-scroll-container">
            <div class="sidebar-top">
                <SidebarNavigation title={title} />

                <h1 class="sidebar-project-title">{title}</h1>

                {
                    tags.length > 0 && (
                        <div class="sidebar-tags">
                            {tags.map((tag) => (
                                <span>{tag}</span>
                            ))}
                        </div>
                    )
                }

                {
                    description && (
                        <p class="sidebar-project-desc">{description}</p>
                    )
                }

                {
                    metaEntries.length > 0 && (
                        <div class="project-meta-table">
                            {metaEntries.map(([label, value]) => (
                                <div class="meta-row">
                                    <span class="meta-label">{label}</span>
                                    <span class="meta-value">{value}</span>
                                </div>
                            ))}
                        </div>
                    )
                }

                {
                    ctaUrl && (
                        <a href={ctaUrl} target="_blank" rel="noopener noreferrer" class="sidebar-cta-button">
                            {ctaText || "Try it out"}
                        </a>
                    )
                }
            </div>
        </div>

        <div class="sidebar-bottom">
            <nav class="toc-nav">
                <ul>
                    <div class="active-indicator"></div>
                    {
                        sections.map((section) => (
                            <li>
                                <a
                                    href={`#${section.id}`}
                                    class="toc-link"
                                    data-target={section.id}
                                >
                                    {section.label}
                                </a>
                            </li>
                        ))
                    }
                </ul>
            </nav>
            <div class="theme-toggle-wrapper">
                <ThemeToggle />
            </div>
        </div>
    </div>

    <!-- RIGHT CONTENT SLOT -->
    <article class="right-content">
        <slot />
    </article>
</Layout>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tocLinks = document.querySelectorAll(".toc-link");
        const sections = document.querySelectorAll("section.project-section");
        const indicator = document.querySelector(".active-indicator");

        const updateIndicator = (activeLi) => {
            if (activeLi && indicator) {
                const top = activeLi.offsetTop;
                const height = activeLi.offsetHeight;
                indicator.style.top = `${top}px`;
                indicator.style.height = `${height}px`;
                indicator.style.opacity = "1";
            }
        };

        const observerOptions = {
            root: null,
            rootMargin: "-20% 0px -60% 0px", // Trigger when section is near top/middle
            threshold: 0,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const group = entry.target.getAttribute("data-toc-group");
                    const id = group || entry.target.getAttribute("id");

                    // Remove active class from all links
                    tocLinks.forEach((link) => {
                        link.classList.remove("active");
                        link.parentElement?.classList.remove("active-item");
                    });

                    // Add active class to current link AND update indicator
                    if (id) {
                        const activeLink = document.querySelector(
                            `.toc-link[data-target="${id}"]`,
                        );
                        if (activeLink) {
                            activeLink.classList.add("active");
                            const parentLi = activeLink.parentElement;
                            parentLi?.classList.add("active-item");
                            if (parentLi) updateIndicator(parentLi);
                        }
                    }
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });
    });
</script>

<style>
    /* Sidebar Internal Styling */
    .project-sidebar-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
        font-family: "Inter", sans-serif;
    }

    /* Allow scrolling if content is too tall */
    .sidebar-scroll-container {
        display: flex;
        flex-direction: column;
        gap: var(--space-xl);
    }

    .sidebar-top {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .sidebar-project-title {
        font-size: 1.125rem; /* ~18px */
        line-height: 1.3;
        font-weight: 600;
        margin-top: var(--space-lg);
        margin-bottom: 0.5rem;
        letter-spacing: -0.01em;
    }

    .sidebar-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .sidebar-tags span {
        font-size: 0.75rem; /* 12px */
        color: var(--text-muted);x
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
    }

    .sidebar-tags span:not(:last-child)::after {
        content: "â€¢";
        margin-left: 0.5rem;
        opacity: 0.3;
    }

    .sidebar-project-desc {
        color: var(--text-secondary);
        line-height: 1.6;
        font-size: 0.75rem; /* 14px */
        margin-bottom: 2rem;
    }

    .sidebar-cta-button {
        display: inline-block;
        background-color: var(--surface-secondary);
        color: var(--text-primary);
        border: 2px solid var(--accent-secondary);
        padding: 6px 8px; /* Matched to Navbar */
        border-radius: var(--radius-md); /* Matched to Navbar (8px) */
        text-decoration: none;
        font-weight: 500;
        font-size: 0.875rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        transition: box-shadow 0.2s ease, opacity 0.2s;
        text-align: center;
        width: 100%;
        box-sizing: border-box;
    }
    .sidebar-cta-button:hover {
        box-shadow: 0 0 16px rgba(100, 200, 150, 0.5);
        background-color: var(--surface-primary); /* Brighter overlap */
        filter: brightness(1.05);
    }
    :global(.dark) .sidebar-cta-button:hover {
        background-color: var(--surface-tertiary); /* Darker overlap */
        filter: brightness(0.92);
    }

    /* TABLET/MOBILE STYLES */
    @media (max-width: 1024px) {
        .sidebar-cta-button {
            display: none;
        }

        .toc-nav {
            display: none;
        }
    }

    /* TOC STYLES */
    .toc-nav {
        margin: 1rem 0;
    }

    .toc-nav ul {
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 6px; /* Reduced from 1rem to 6px */
        /* Line moved to RIGHT */
        border-right: 1px solid var(--border-subtle);
        border-left: none;
        margin-left: 0;
        padding-left: 0;
        position: relative; /* Essential for absolute indicator */
    }

    .toc-nav li {
        margin-left: 0;
        margin-right: 0;
        padding-left: 0;
        padding-right: 1.5rem;
        /* Border removed in favor of pseudo-element for centering */
        border-right: none;
        border-left: none;
        transition: all 0.2s;
        text-align: left;
        position: relative; /* For pseudo-element positioning */
    }

    /* Active State Indicator (Sliding) */
    .active-indicator {
        position: absolute;
        right: -2px; /* Centered on border */
        width: 3px;
        background-color: var(--accent-secondary);
        border-radius: 1px;
        transition: top 0.25s cubic-bezier(0.25, 0.8, 0.25, 1), height 0.25s ease, opacity 0.2s;
        opacity: 0;
        pointer-events: none;
    }

    .toc-nav a {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem; /* 14px */
        transition: color 0.2s;
        display: block;
        font-weight: 500;
        /* text-transform: lowercase; Removed to allow AI capitalization */
    }

    .toc-nav a:hover {
        color: var(--text-primary);
    }

    /* Active State */
    .toc-nav a.active {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* META TABLE STYLES */
    .sidebar-bottom {
        display: flex;
        flex-direction: column;
        padding-top: 2rem;
    }

    .project-meta-table {
        display: flex;
        flex-direction: column;
        border-top: 1px solid var(--border-subtle);
        padding-top: 0; /* Removed 16px padding */
    }

    .meta-row {
        display: grid;
        grid-template-columns: 100px 1fr; /* Fixed Label width, increased to prevent overlap */
        gap: 1rem;
        padding: 0.3rem 0;
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.75rem; /* 12px */
    }

    .meta-label {
        font-weight: 600;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .meta-value {
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .theme-toggle-wrapper {
        margin-top: auto;
    }

    /* RIGHT CONTENT STYLES (Hero Section) */
    .right-content {
        padding: 4rem; /* 64px equal on all sides */
        max-width: none; /* Use full available width */
        margin: 0;
        font-family: "Public Sans", sans-serif;
        scroll-behavior: smooth;
    }

    /* Remove redundant top margin from first element (Hero Image usually) */
    .right-content > :global(:first-child) {
        margin-top: 0 !important;
    }

    /* Ensure scroll margin for anchors so sticky headers don't cover them */
    .right-content :global(section) {
        scroll-margin-top: 2rem;
    }

    @media (max-width: 1024px) {
        .right-content {
            padding: 20px;
        }

        /* Hide TOC on mobile */
        .toc-nav {
            display: none;
        }

        /* Fixed Theme Toggle on Mobile */
        .theme-toggle-wrapper {
            position: fixed;
            bottom: var(--space-md);
            left: var(--space-md); /* Moved to Bottom Left */
            z-index: 90;
            margin-top: 0;
        }

        /* Allow sidebar to collapse vertically */
        .project-sidebar-content {
            height: auto;
            display: block;
        }
    }
</style>
