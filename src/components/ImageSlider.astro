---
interface Slide {
    src: string;
    alt: string;
    label: string;
}

import { Image } from "astro:assets";

interface Props {
    slides: Slide[];
}

const { slides } = Astro.props;
const sliderId = `slider-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="image-slider" id={sliderId}>
    <div class="slider-display">
        <div class="slider-track">
            {
                slides.map((slide, index) => (
                    <div class="slide" data-index={index}>
                        <Image
                            src={slide.src}
                            alt={slide.alt}
                            width={1920}
                            height={1080}
                            loading="lazy"
                            decoding="async"
                            class="optimized-slide-image"
                        />
                    </div>
                ))
            }
        </div>
    </div>

    <div class="slider-controls">
        <div class="active-pill"></div>
        {
            slides.map((slide, index) => (
                <button
                    class={`control-btn ${index === 0 ? "active" : ""}`}
                    data-target={index}
                >
                    {slide.label}
                </button>
            ))
        }
    </div>
</div>

<style>
    .image-slider {
        width: 100%;
        margin-top: 4rem;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        /* Constrain to 900px body width */
        padding-inline: max(0rem, calc(50% - 450px));
        box-sizing: border-box;
    }

    .slider-display {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: var(--radius-md);
        overflow: hidden;
        background: var(--surface-secondary);
    }

    .slider-track {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .slide {
        min-width: 100%;
        height: 100%;
        position: relative;
    }

    .slide .optimized-slide-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* CONTROLS (Bento Segmented Control) */
    .slider-controls {
        display: flex;
        position: relative;
        justify-content: center;
        gap: 0;
        background: var(--bg-surface);
        padding: 4px; /* Reduced from 6px back to 4px for tighter bento */
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
        width: fit-content;
        margin: 0 auto;
        z-index: 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    /* Default State (Problem / Index 0) - Blue */
    .active-pill {
        position: absolute;
        top: 4px; /* Matches container padding */
        left: 4px;
        height: calc(100% - 8px);
        background: #2196F3; /* Blue for both light and dark mode */
        border-radius: var(--radius-sm);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition:
            all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
            background-color 0.3s ease;
        z-index: 1;
        width: 0;
        opacity: 0;
    }

    /* Conditional State: Opportunity (Index 1) - Blue */
    .slider-controls[data-active-index="1"] .active-pill {
        background: #2196F3; /* Blue for both light and dark mode */
    }

    .control-btn {
        background: transparent;
        border: none;
        padding: 0.5rem 1rem; /* Decreased padding for smaller size */
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 12px; /* User Request: 12px */
        font-weight: 600;
        cursor: pointer;
        transition: color 0.2s ease;
        z-index: 2;
        position: relative;
        font-family: var(--font-sans);
        text-transform: uppercase; /* Usually bento nav items are uppercase, checking ref... SidebarNav uses uppercase. Let's add uppercase to match "bento" feel if appropriate, or keep mixed case. User didn't ask for uppercase but usually 12px works well with it. I'll stick to original casing unless SidebarNav dictates. SidebarNav "HOME", "ABOUT" are uppercase. ImageSlider labels "The Problem" are sentence case. I'll keep user labels. */
        letter-spacing: 0.02em;
    }

    .control-btn:hover {
        color: var(--text-primary);
    }

    .control-btn.active {
        color: var(--bg-surface); /* Contrast text */
    }

    @media (max-width: 768px) {
        .slider-controls {
            margin-left: 0; /* Left align */
            justify-content: flex-start; /* Ensure content starts from left if width expands */
        }
    }
</style>

<script define:vars={{ sliderId }}>
    document.addEventListener("DOMContentLoaded", () => {
        const slider = document.getElementById(sliderId);
        if (!slider) return;

        const track = slider.querySelector(".slider-track");
        const controls = slider.querySelector(".slider-controls");
        const buttons = slider.querySelectorAll(".control-btn");
        const pill = slider.querySelector(".active-pill");

        let isDragging = false;
        let dragStarted = false;
        let startX = 0;
        let startY = 0;
        let currentHoverButton = null;

        const movePillTo = (targetBtn) => {
            if (!targetBtn || !pill) return;

            const offsetLeft = targetBtn.offsetLeft;
            const width = targetBtn.offsetWidth;

            pill.style.width = `${width}px`;
            pill.style.transform = `translateX(${offsetLeft - 4}px)`;
            pill.style.opacity = "1";
        };

        const switchToSlide = (targetBtn) => {
            if (!targetBtn) return;
            
            const targetIndex = parseInt(targetBtn.getAttribute("data-target"));

            // Update Buttons
            buttons.forEach((b) => b.classList.remove("active"));
            targetBtn.classList.add("active");

            // Update Container State (Color)
            if (controls)
                controls.setAttribute("data-active-index", targetIndex);

            // Move Pill
            movePillTo(targetBtn);

            // Sliding Animation
            const percentage = targetIndex * 100;
            track.style.transform = `translateX(-${percentage}%)`;
        };

        // Initialize Pill
        const initialActive = slider.querySelector(".control-btn.active");
        setTimeout(() => {
            if (initialActive) {
                movePillTo(initialActive);
                const idx = initialActive.getAttribute("data-target");
                if (controls) controls.setAttribute("data-active-index", idx);
            }
        }, 50);

        const handleStart = (e) => {
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            startX = clientX;
            startY = clientY;
            isDragging = true;
            dragStarted = false;
        };

        const handleMove = (e) => {
            if (!isDragging) return;

            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            const deltaX = Math.abs(clientX - startX);
            const deltaY = Math.abs(clientY - startY);

            // Only activate drag if moving more horizontally than vertically
            if (deltaX > 5 && deltaX > deltaY) {
                dragStarted = true;

                // Find which button we're hovering over
                const hoveredBtn = Array.from(buttons).find((btn) => {
                    const rect = btn.getBoundingClientRect();
                    return clientX >= rect.left && clientX <= rect.right;
                });

                if (hoveredBtn !== currentHoverButton) {
                    currentHoverButton = hoveredBtn;
                    
                    // Move pill to hovered button
                    if (hoveredBtn) {
                        movePillTo(hoveredBtn);
                    }
                }
                
                // Update text colors: white for both active and currently hovered buttons
                buttons.forEach((btn) => {
                    if (btn.classList.contains('active') || btn === currentHoverButton) {
                        btn.style.color = 'var(--bg-surface)'; // White text
                    } else {
                        btn.style.color = ''; // Reset to default
                    }
                });

                e.preventDefault();
            }
        };

        const handleEnd = (e) => {
            if (!isDragging) return;

            if (dragStarted && currentHoverButton) {
                // Switch to the button we released on
                switchToSlide(currentHoverButton);
            } else if (!dragStarted) {
                // It was just a click - find which button was clicked
                const target = e.target.closest('.control-btn');
                if (target) {
                    switchToSlide(target);
                }
            }

            // Reset text colors
            buttons.forEach((btn) => {
                btn.style.color = '';
            });
            
            isDragging = false;
            dragStarted = false;
            currentHoverButton = null;
        };

        // Attach events to controls container
        controls.addEventListener("mousedown", handleStart);
        controls.addEventListener("touchstart", handleStart, { passive: true });
        
        document.addEventListener("mousemove", handleMove);
        document.addEventListener("touchmove", handleMove, { passive: false });
        
        document.addEventListener("mouseup", handleEnd);
        document.addEventListener("touchend", handleEnd);

        // Handle Resize
        window.addEventListener("resize", () => {
            const active = slider.querySelector(".control-btn.active");
            if (active) movePillTo(active);
        });
    });
</script>
