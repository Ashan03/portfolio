---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import happyLogo from "../assets/happy.png";

interface Props {
    title?: string;
    isHome?: boolean;
}

const { title, isHome = false } = Astro.props;

// Fetch and group projects
const allProjects = await getCollection("projects");

const categories = [
    { id: "thinking", label: "Tools for Thinking" },
    { id: "spatial", label: "Spatial Interactions" },
    { id: "embodied", label: "Tangible Interactions" },
    { id: "strategy", label: "Design Strategy" },
];

const projectsByCategory = categories.map((cat) => ({
    ...cat,
    projects: allProjects
        .filter((p) => p.data.category === cat.id)
        .sort((a, b) => (a.data.order || 0) - (b.data.order || 0)),
}));
---

<div class="nav-spacer"></div>
<div class="nav-bento-wrapper">
    <div
        id="nav-trigger"
        class="nav-trigger"
        aria-expanded="false"
        aria-controls="nav-dropdown"
        role="button"
        tabindex="0"
    >
        <div class="nav-content">
            <a href="/" class="logo link-item nav-header-icon-container">
                <Image
                    src={happyLogo}
                    alt="na"
                    class="nav-logo logo-img"
                    loading="lazy"
                    decoding="async"
                    width={24}
                    height={24}
                />
            </a>

            {
                isHome ? (
                    <span id="nav-section-label" class="crumb-current">HOME</span>
                ) : (
                    <>
                        <a href="/#works" class="crumb-link link-item">
                            Works
                        </a>
                        <span class="crumb-current nav-header-label">{title}</span>
                    </>
                )
            }
        </div>
        <div class="nav-icon">
            <svg
                width="12"
                height="12"
                viewBox="0 0 12 12"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="arrow-icon"
            >
                <path
                    d="M2.5 4.5L6 8L9.5 4.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
        </div>
    </div>

    <!-- Tree View Dropdown -->
    <div
        id="nav-dropdown"
        class="nav-dropdown hidden"
    >
        <nav class="tree-menu">
            <!-- 1. Home (Only show if NOT home) -->
            {
                !isHome && (
                    <div class="tree-item">
                        <a href="/" class="tree-link single-action">
                            <span class="tree-icon nav-item-icon-container">
                                <!-- Home Icon (Lucide) -->
                                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                            </span>
                            <span class="tree-label nav-item-text">HOME</span>
                        </a>
                    </div>
                )
            }

            <!-- 2. About (Abstract Circle Icon) -->
            <div class="tree-item">
                <a href="/#about" id="nav-about" class="tree-link single-action">
                    <span class="tree-icon">
                         <!-- Info Icon (Lucide) -->
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    </span>
                    <span class="tree-label">ABOUT</span>
                </a>
            </div>

            <!-- 3. Works (Folder with Split Interaction) -->
            <div class="tree-item folder">
                <div class="tree-link split-action">
                    <!-- Link Area (Left) -->
                    <a href="/#works" class="split-link">
                        <span class="tree-icon folder-icon">
                             <!-- Folder Icon (Lucide) -->
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                        </span>
                        <span class="tree-label nav-item-text">WORKS</span>
                    </a>
                    
                    <!-- Toggle Area (Right - The Rail) -->
                    <div class="toggle-container right-rail">
                        <button class="split-toggle folder-trigger" aria-label="Toggle Works">
                            <svg width="10" height="6" viewBox="0 0 10 6" fill="none" class="toggle-chevron">
                                 <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="tree-children-wrapper">
                    <div class="tree-children">
                         <div class="tree-guide-line"></div> <!-- Left Guide Line for Tree -->
                        {
                            projectsByCategory.map((category) => (
                                <div class="tree-item folder subfolder">
                                    <div class="tree-link split-action">
                                         <!-- Category Link -->
                                        <a href={`/#${category.id}`} class="split-link">
                                            <span class="tree-icon folder-icon nav-item-icon-container">
                                                <!-- Smaller Folder -->
                                                 <svg width="14" height="14" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1.5 3.5V11.5C1.5 12.0523 1.94772 12.5 2.5 12.5H12.5C13.0523 12.5 13.5 12.0523 13.5 11.5V5.5C13.5 4.94772 13.0523 4.5 12.5 4.5H7.5L5.5 2.5H2.5C1.94772 2.5 1.5 2.94772 1.5 3.5Z" stroke="currentColor" stroke-linejoin="round"/></svg>
                                            </span>
                                            <span class="tree-label nav-item-text">{category.label}</span>
                                        </a>
                                        <!-- Category Toggle (Right Rail) -->
                                        <div class="toggle-container right-rail">
                                            <button class="split-toggle folder-trigger" aria-label={`Toggle ${category.label}`}>
                                                <svg width="10" height="6" viewBox="0 0 10 6" fill="none" class="toggle-chevron">
                                                    <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="tree-children-wrapper">
                                        <div class="tree-children sub-children">
                                            <div class="tree-guide-line nested"></div>
                                            {category.projects.map((project) => (
                                                <div class="tree-item">
                                                    <a
                                                        href={`/works/${project.slug}`}
                                                        class="tree-link single-action file-link"
                                                    >
                                                        <span class="tree-label nav-item-text">
                                                            {project.data.title}
                                                        </span>
                                                    </a>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>

            <!-- 4. Contact (Person Icon) -->
            <div class="tree-item">
                <a href="/#contact" class="tree-link single-action">
                    <span class="tree-icon">
                        <!-- User Icon (Lucide) -->
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </span>
                    <span class="tree-label">CONTACT</span>
                </a>
            </div>
        </nav>
    </div>
</div>

<script>
    const trigger = document.getElementById("nav-trigger");
    const dropdown = document.getElementById("nav-dropdown");

    // Toggle main menu
    trigger?.addEventListener("click", (e) => {
        if (window.innerWidth <= 1024) return;
        if ((e.target as HTMLElement).closest("a")) return;

        e.stopPropagation();
        const isExpanded = trigger?.getAttribute("aria-expanded") === "true";
        const navLabel = document.getElementById('nav-section-label');

        trigger?.setAttribute("aria-expanded", (!isExpanded).toString());
        dropdown?.classList.toggle("hidden");
        trigger?.classList.toggle("active");
        
        // Update label based on menu state
        if (!isExpanded) {
            // Opening menu - set to HOME
            if (navLabel) navLabel.textContent = 'HOME';
        } else {
            // Closing menu - restore active section
            if (typeof updateActiveState === 'function') {
                updateActiveState();
            }
        }
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
        // Don't close if clicking Read More button - preserve nav state
        const readMoreBtn = document.getElementById("read-more-btn");
        const clickedReadMore = readMoreBtn?.contains(e.target as Node);
        
        if (
            !trigger?.contains(e.target as Node) &&
            !dropdown?.contains(e.target as Node) &&
            !clickedReadMore
        ) {
            trigger?.setAttribute("aria-expanded", "false");
            dropdown?.classList.add("hidden");
            trigger?.classList.remove("active");
            
            // Restore active section label
            if (typeof updateActiveState === 'function') {
                updateActiveState();
            }
        }
    });

    // Toggle Folders (Accordion Behavior)
    const folderTriggers = document.querySelectorAll(".folder-trigger");
    folderTriggers.forEach((ft) => {
        ft.addEventListener("click", (e) => {
            e.stopPropagation(); 
            e.preventDefault();
            const currentFolder = ft.closest(".folder");
            if (!currentFolder) return;

            // Accordion: Close other siblings
            const parent = currentFolder.parentElement;
            // The parent of the folder is likely .tree-children (because of the wrapper)
             // or .tree-menu for top level
            
            // If we are in the "Works" list (subfolders), close siblings
            if (currentFolder.classList.contains("subfolder")) {
                 // The parent of subfolders is .tree-children (inside the wrapper)
                 const parentList = currentFolder.closest('.tree-children');
                 const siblings = parentList?.querySelectorAll(":scope > .subfolder.expanded");
                 siblings?.forEach(sibling => {
                     if (sibling !== currentFolder) {
                         sibling.classList.remove("expanded");
                         const btn = sibling.querySelector(".folder-trigger");
                         btn?.classList.remove("active");
                     }
                 });
            }

            currentFolder.classList.toggle("expanded");
            ft.classList.toggle("active");
        });
    });

    // --- Priority State Manager for Navigation ---
    
    const navTrigger = document.getElementById("nav-trigger");
    const aboutLink = document.getElementById("nav-about");
    const readMoreBtn = document.getElementById("read-more-btn");
    
    // Track read more state
    let isReadMoreExpanded = false;

    // Listen to Read More Toggle (Manual Event)
    if (readMoreBtn) {
        // Use MutationObserver to be 100% sure of state change
        const mutationObserver = new MutationObserver(() => {
            isReadMoreExpanded = readMoreBtn.classList.contains('active');
            updateActiveState(); // Force update immediately
        });
        mutationObserver.observe(readMoreBtn, { attributes: true, attributeFilter: ['class'] });
        
        // Also listen to click for immediate feedback if needed, but observer covers it.
    }

    function updateActiveState() {
        if (!navTrigger) return;
        
        const navLabel = document.getElementById('nav-section-label');
        const isMenuOpen = navTrigger.getAttribute("aria-expanded") === "true";

        // ============================================
        // STEP 1: RESET ALL HIGHLIGHTS (Radio Button Rule)
        // Clear everything FIRST, then apply the correct one.
        // ============================================
        navTrigger.classList.remove('active-highlight');
        aboutLink?.classList.remove('active-scroll');
        document.querySelectorAll('.active-scroll').forEach(el => el.classList.remove('active-scroll'));

        // ============================================
        // STEP 2: Apply the correct highlight based on priority
        // ============================================

        // PRIORITY 0: Menu Open State (Label Override)
        if (isMenuOpen) {
             if (navLabel) navLabel.textContent = 'HOME';
        }

        // 1. PRIORITY: Read More (About Section)
        if (isReadMoreExpanded) {
            aboutLink?.classList.add('active-scroll');
            
            if (!isMenuOpen) {
                if (navLabel) navLabel.textContent = 'ABOUT';
            }
            return; // STOP here.
        }

        // 2. PRIORITY: Home Zone (Top of Page)
        const worksSection = document.getElementById('works');
        const worksTop = worksSection ? (worksSection.offsetTop - 100) : 99999; 
        
        if (window.scrollY < worksTop) {
            // Home/Bio Zone
            
            // Always highlight Home trigger
            navTrigger.classList.add('active-highlight');
            
            if (!isMenuOpen) {
                if (navLabel) navLabel.textContent = 'HOME';
            }
            return; // STOP here.
        }

        // 3. PRIORITY: Works / Contact Zone
        const contactSection = document.getElementById('contact');
        const contactTop = contactSection ? (contactSection.offsetTop - 300) : 99999; 
        
        if (window.scrollY >= contactTop) {
            // Contact Zone
            if (!isMenuOpen) {
                if (navLabel) navLabel.textContent = 'CONTACT';
            }
            const contactLink = document.querySelector('a[href="/#contact"]');
            contactLink?.classList.add('active-scroll');
        } else {
            // Works Zone
            if (!isMenuOpen) {
                 if (navLabel) navLabel.textContent = 'WORKS';
            }
            
            // Highlight Works box (Target the PARENT split-action container)
            const worksLink = document.querySelector('.split-link[href="/#works"]')?.closest('.split-action');
            worksLink?.classList.add('active-scroll');
            
            updateCategoryHighlight();
        }
    }
    
    function updateCategoryHighlight() {
        // Simple bounding check for categories
        const categories = ["thinking", "embodied", "spatial", "strategy"];
        let activeCatId = null;
        
        // Find the one closest to top but still visible?
        // Or essentially first one that is "in view".
        
        for (const id of categories) {
            const section = document.getElementById(id);
            if (section) {
                const rect = section.getBoundingClientRect();
                // If top is somewhat in view (e.g. < 50% viewport height and bottom > 0)
                if (rect.top < (window.innerHeight * 0.5) && rect.bottom > 0) {
                    activeCatId = id;
                 }
            }
        }
        
        if (activeCatId) {
            // Highlight this category
            const catLink = document.querySelector(`.split-link[href="/#${activeCatId}"]`);
            catLink?.classList.add('active-scroll');
            
            // Remove others
             categories.forEach(id => {
                 if (id !== activeCatId) {
                     document.querySelector(`.split-link[href="/#${id}"]`)?.classList.remove('active-scroll');
                 }
             });
        }
    }

    // Scroll Listener (Throttled?)
    window.addEventListener('scroll', () => {
        window.requestAnimationFrame(updateActiveState);
    });
    
    // Initial Call
    updateActiveState();

</script>

<style>
    .nav-spacer {
        display: none;
    }
    /* Styles continue... */

</script>

<style>
    .nav-spacer {
        display: none;
    }

    .nav-bento-wrapper {
        position: relative;
        margin-bottom: var(--space-md);
    }

    /* Base Styles */
    .nav-trigger {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        padding: 6px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        color: inherit;
        font-family: inherit;
        border-radius: var(--radius-md);
    }

    .nav-trigger:hover {
        border-color: var(--border-focus);
        background: var(--bg-surface-hover);
    }
    
    /* Highlight State (Background Color) */
    .nav-trigger.active-highlight {
        background: var(--bg-surface-hover);
        border-color: var(--border-focus);
    }

    /* Active/Open State (Shape Only) */
    .nav-trigger.active {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    /* Active Scroll State for Links */
    .active-scroll {
        background: var(--bg-surface-hover);
        color: var(--text-primary) !important; /* Force override */
    }
    
    /* Ensure icon inside active link also lights up */
    .active-scroll .tree-icon {
        opacity: 1;
        color: var(--text-primary);
    }

    .nav-content {
        display: flex;
        align-items: center;
        gap: 12px; /* Control spacing here */
        font-size: 12px;
        overflow: hidden;
        white-space: nowrap;
        
    }

    /* Links */
    .link-item {
        color: var(--text-secondary);
        text-decoration: none;
        transition: color 0.2s ease;
        position: relative;
        z-index: 2;
    }

    .link-item:hover {
        color: var(--accent-secondary);
    }

    .logo {
        font-family: var(--font-mono);
        font-weight: 800;
        color: var(--text-primary);
        display: flex;
        align-items: center;
    }

    .logo-img {
        width: 24px;
        height: 24px;
        object-fit: contain;
        border-radius: 50%;
    }

    .crumb-link {
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    .crumb-current {
        color: var(--text-secondary);
        font-weight: 600;
        text-overflow: ellipsis;
        overflow: hidden;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.05em;
    }

    /* --- Tree View Dropdown Styles --- */
    .nav-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-top: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 50;
        border-bottom-left-radius: var(--radius-md);
        border-bottom-right-radius: var(--radius-md);
        overflow: hidden;
        max-height: 80vh;
        overflow-y: auto;
    }

    .nav-dropdown.hidden {
        display: none;
    }

    .tree-menu {
        display: flex;
        flex-direction: column;
        user-select: none;
    }

    .tree-item {
        position: relative;
        border-bottom: 1px solid var(--border-subtle); /* Separator Line */
    }
    
    .tree-item:last-child {
        border-bottom: none;
    }

    /* Shared row styling */
    .tree-link {
        display: flex;
        align-items: center;
        width: 100%;
        box-sizing: border-box;
        text-decoration: none;
        color: var(--text-secondary);
        font-size: 12px;
        transition: background 0.2s ease, color 0.2s ease;
        gap: 12px; /* Control spacing here */
    }
    
    .single-action {
        padding: 10px 16px 10px 9px; /* top right bottom left */
    }
    
    .single-action:hover {
        background: var(--bg-surface-hover);
        color: var(--accent-secondary);
    }

    .tree-icon {
        width: 24px; /* Back to small fixed size for icon centering */
        display: flex;
        justify-content: center;
        align-items: center;
        /* No margin, gap handled by parent */
        font-size: 14px;
        opacity: 0.7;
        color: inherit;
        flex-shrink: 0;
    }

    /* Top Level Labels */
    .tree-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-transform: uppercase;
        font-weight: 500;
        letter-spacing: 0.05em;
        flex: 1;
    }

    /* Split Interaction */
    .split-action {
        display: flex;
        align-items: stretch;
        padding: 0; /* No padding on container */
    }

    .split-link {
        flex: 1;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        transition: background 0.2s ease;
        padding: 10px 16px 10px 10px; /* matched to single-action */
        gap: 12px; /* Add spacing between Icon and Text */
    }
    
    .split-link:hover {
        background: var(--bg-surface-hover);
        color: var(--accent-secondary);
    }
    
    .toggle-container {
        border-left: none; /* Removed border as requested */
        display: flex;
        align-items: stretch;
        background: transparent;
    }

    .split-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-secondary);
        transition: background 0.2s ease, color 0.2s ease;
    }
    
    .split-toggle:hover {
        background: var(--bg-surface-hover);
        color: var(--text-primary);
    }
    
    .toggle-chevron {
        transition: transform 0.2s ease;
    }
    
    .split-toggle.active .toggle-chevron {
        transform: rotate(180deg);
    }

    /* --- Animation Wrapper --- */
    .tree-children-wrapper {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Ease-in-out ish */
    }

    .tree-children {
        overflow: hidden;
        position: relative;
    }

    .folder.expanded > .tree-children-wrapper {
        grid-template-rows: 1fr;
    }

    /* --- Tree Hierarchy Lines --- */
    .tree-guide-line {
        position: absolute;
        left: 24px; /* Align with center of Top Level Icons */
        top: 0;
        bottom: 0;
        width: 1px;
        background: var(--border-subtle);
        opacity: 0.5;
        z-index: 1;
    }
    
    .tree-guide-line.nested {
        left: 41px; /* Align with center of subfolder icon (32px padding + 9px half-width) */
    }

    /* Subfolder Items */
    .subfolder.tree-item {
        border-bottom: none; 
    }
    
    /* Remove borders for all children inside the dropdown (Categories & Projects) */
    .tree-children .tree-item {
        border-bottom: none;
    }

    /* Indentation for Sub-Items (Tree View) */
    .subfolder .split-link {
        padding-left: 30px; /* Reduced by 2px (32->30) */
        padding-top: 6px;   /* Reduced Vertical Padding */
        padding-bottom: 6px;
    }
    
    .subfolder .tree-label {
        text-transform: none; /* Sentence case! */
        font-weight: 400;
        font-size: 13px;
        color: var(--text-primary);
    }
    
    /* File Links (Projects) */
    .file-link.tree-link {
        padding-left: 60px; /* Increased separation from guide line */
        padding-top: 6px;   /* Reduced Vertical Padding */
        padding-bottom: 6px;
    }
    
    .file-link .tree-label {
        font-weight: 400;
        color: var(--text-secondary);
        text-transform: none;
        font-size: 13px; /* Matched to Category Font Size */
    }
    
    /* Spacing: Tighten Parent->Child */
    /* Handled by reduced padding in items if needed, or margin. 
       Currently using padding inside links. */
    
    /* Ensure Right Rail aligns continuously */
    /* The .toggle-container borders align because they are all right-aligned flex items width 40px */
    
    /* Subfolder Icons */
    .subfolder .tree-icon {
        width: 18px; /* Slightly smaller */
    }

    /* Active State for Links AND Split Actions (Whole Box) */
    .active-scroll,
    .split-action.active-scroll {
        background: var(--bg-surface-hover);
        color: var(--text-primary) !important;
    }
    
    /* When parent is active, children should be transparent/inherit */
    .split-action.active-scroll .split-link,
    .split-action.active-scroll .toggle-container {
        background: transparent !important;
        color: inherit;
    }

    @media (max-width: 1024px) {
        .nav-spacer {
            display: block;
            height: 50px;
        }

        .nav-bento-wrapper {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            width: auto;
            z-index: 100;
            margin: 0;
        }

        .nav-trigger {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            cursor: default;
        }

        .nav-trigger:hover {
            background: var(--bg-surface);
            border-color: var(--border-subtle);
            cursor: default;
        }

        .nav-trigger.active {
            border-radius: var(--radius-md);
        }

        .nav-icon {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .nav-bento-wrapper {
            top: var(--space-md);
            left: var(--space-md);
            right: var(--space-md);
        }
    }

    /* --- UI Refinements --- */
    /* 1. Alignment Fix (Refactored) */
    .nav-item-icon-container, 
    .nav-header-icon-container {
        /* Removed fixed width 48px */
        display: flex;
        justify-content: center; 
        align-items: center;
        flex-shrink: 0; 
        width: 24px; /* Standardize icon box size */
    }

    /* 2. Logo Resize */
    .nav-logo {
        width: 22px ; 
        height: 22px ;
    }

    /* 3. Text Alignment */
    .nav-item-text, 
    .nav-header-label {
        padding-left: 0px; /* Remove extra padding, rely on the container width */
        text-align: left;
    }
</style>
