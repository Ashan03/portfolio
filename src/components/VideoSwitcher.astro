---
interface VideoOption {
    label: string;
    src: string;
}

interface Props {
    videos: VideoOption[];
    initialIndex?: number;
    constrain?: boolean;
}

const { videos, initialIndex = 0, constrain = true } = Astro.props;
const switcherId = `video-switcher-${Math.random().toString(36).substr(2, 9)}`;
---

<div class:list={["video-switcher", { unconstrained: !constrain }]} id={switcherId}>
    <div class="video-display">
        {
            videos.map((video, index) => (
                <video
                    id={`${switcherId}-video-${index}`}
                    src={video.src}
                    class={`video-item ${index === initialIndex ? "active" : ""}`}
                    autoplay={index === initialIndex}
                    loop
                    playsinline
                    preload="auto"
                />
            ))
        }

        <button class="mute-toggle" aria-label="Toggle mute">
            <svg
                class="icon-mute"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style="display: none;"
            >
                <path
                    d="M11 5L6 9H2V15H6L11 19V5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                <path
                    d="M23 9L17 15"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                <path
                    d="M17 9L23 15"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
            <svg
                class="icon-sound"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                style="display: block;"
            >
                <path
                    d="M11 5L6 9H2V15H6L11 19V5Z"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                <path
                    d="M19.07 4.93C20.9447 6.80527 21.9979 9.34836 21.9979 12C21.9979 14.6516 20.9447 17.1947 19.07 19.07M15.54 8.46C16.4774 9.39763 17.0039 10.6692 17.0039 12C17.0039 13.3308 16.4774 14.6024 15.54 15.54"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
        </button>
    </div>

    <div class="switcher-controls">
        <div class="active-pill"></div>
        {
            videos.map((video, index) => (
                <button
                    class={`control-btn ${index === initialIndex ? "active" : ""}`}
                    data-index={index}
                >
                    {video.label}
                </button>
            ))
        }
    </div>
</div>

<style>
    .video-switcher {
        width: 100%;
        margin-top: 2rem;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-inline: max(0rem, calc(50% - 450px));
        box-sizing: border-box;
    }

    .video-switcher.unconstrained {
        padding-inline: 0 !important;
        max-width: 100%;
    }

    .video-display {
        position: relative;
        width: 100%;
        height: auto;
        border-radius: var(--radius-md);
        overflow: hidden;
        background: #000000;
        line-height: 0;
        padding-top: 16px;
        padding-bottom: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .video-item {
        display: none !important; /* Force hide by default */
        width: 100%;
        height: auto;
        object-fit: contain;
        max-height: 80vh;
        margin: 0 !important;
    }

    .video-item.active {
        display: block !important; /* Force show when active */
    }

    .mute-toggle {
        position: absolute;
        bottom: 24px;
        right: 24px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: white;
        transition: all 0.2s ease;
        z-index: 10;
        backdrop-filter: blur(4px);
    }

    .mute-toggle:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: scale(1.05);
    }

    /* CONTROLS */
    .switcher-controls {
        display: flex;
        position: relative;
        justify-content: center;
        flex-wrap: nowrap;
        overflow-x: auto;
        max-width: 100%;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        gap: 0;
        background: var(--bg-surface);
        padding: 4px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
        width: fit-content;
        margin: 0 auto;
        z-index: 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    .switcher-controls::-webkit-scrollbar {
        display: none;
    }

    @media (max-width: 480px) {
        .switcher-controls {
            width: 100%;
            overflow-x: auto;
            justify-content: flex-start;
        }

        .control-btn {
            padding: 0.4rem 0.75rem;
            font-size: 11px;
        }
    }

    .active-pill {
        position: absolute;
        top: 4px;
        left: 4px;
        height: calc(100% - 8px);
        background: #2196F3; /* Blue for both light and dark mode */
        border-radius: var(--radius-sm);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 1;
        width: 0;
        opacity: 0;
        pointer-events: none;
    }

    .control-btn {
        background: transparent;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: 
            color 0.2s ease,
            opacity 0.15s ease,
            transform 0.15s ease;
        z-index: 2;
        position: relative;
        font-family: var(--font-sans);
        text-transform: uppercase;
        letter-spacing: 0.02em;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .control-btn:hover {
        color: var(--text-primary);
    }

    .control-btn.active {
        color: var(--bg-surface);
    }
</style>

<script define:vars={{ switcherId }}>
    const initVideoSwitcher = () => {
        const container = document.getElementById(switcherId);
        if (!container) return;

        // Use querySelectorAll on container to find elements within this component instance
        const videoItems = container.querySelectorAll(".video-item");
        const muteBtn = container.querySelector(".mute-toggle");
        const iconMute = container.querySelector(".icon-mute");
        const iconSound = container.querySelector(".icon-sound");
        const buttons = container.querySelectorAll(".control-btn");
        const pill = container.querySelector(".active-pill");
        const controls = container.querySelector(".switcher-controls");

        let isMuted = false;
        let isDragging = false;
        let dragStarted = false;
        let startX = 0;
        let startY = 0;
        let currentHoverButton = null;

        // Ensure initial state matches HTML
        videoItems.forEach((v) => {
            if (!v.classList.contains("active")) {
                v.pause();
                v.muted = true;
            } else {
                v.muted = true;
                // Autoplay usually handled by HTML attribute, but force play if needed
                v.play().catch(() => {});
            }
        });

        // Mute Toggle Logic
        muteBtn?.addEventListener("click", () => {
            isMuted = !isMuted;
            if (isMuted) {
                iconMute.style.display = "block";
                iconSound.style.display = "none";
            } else {
                iconMute.style.display = "none";
                iconSound.style.display = "block";
            }
            // Apply to all videos
            videoItems.forEach((v) => (v.muted = isMuted));
        });

        // Pill Logic
        const movePillTo = (targetBtn) => {
            if (!targetBtn || !pill) return;
            const width = targetBtn.offsetWidth;
            const offsetLeft = targetBtn.offsetLeft;

            pill.style.width = `${width}px`;
            pill.style.transform = `translateX(${offsetLeft - 4}px)`;
            pill.style.opacity = "1";
        };

        // Switch Video Function
        const switchToVideo = (targetBtn) => {
            if (!targetBtn) return;
            
            const index = parseInt(targetBtn.getAttribute("data-index"));

            videoItems.forEach((v, i) => {
                if (i === index) {
                    v.classList.add("active");
                    v.muted = isMuted;
                    v.play().catch((e) => console.log("Play error", e));
                } else {
                    v.classList.remove("active");
                    v.pause();
                    v.currentTime = 0;
                }
            });

            buttons.forEach((b) => b.classList.remove("active"));
            targetBtn.classList.add("active");
            movePillTo(targetBtn);
        };

        // Drag Handlers
        const handleStart = (e) => {
            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            startX = clientX;
            startY = clientY;
            isDragging = true;
            dragStarted = false;
        };

        const handleMove = (e) => {
            if (!isDragging) return;

            const clientX = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
            
            const deltaX = Math.abs(clientX - startX);
            const deltaY = Math.abs(clientY - startY);

            // Only activate drag if moving more horizontally than vertically
            if (deltaX > 5 && deltaX > deltaY) {
                dragStarted = true;

                // Find which button we're hovering over
                const hoveredBtn = Array.from(buttons).find((btn) => {
                    const rect = btn.getBoundingClientRect();
                    return clientX >= rect.left && clientX <= rect.right;
                });

                if (hoveredBtn !== currentHoverButton) {
                    currentHoverButton = hoveredBtn;
                    
                    // Move pill to hovered button
                    if (hoveredBtn) {
                        movePillTo(hoveredBtn);
                    }
                }
                
                // Update text colors: white for both active and currently hovered buttons
                buttons.forEach((btn) => {
                    if (btn.classList.contains('active') || btn === currentHoverButton) {
                        btn.style.color = 'var(--bg-surface)'; // White text
                    } else {
                        btn.style.color = ''; // Reset to default
                    }
                });

                e.preventDefault();
            }
        };

        const handleEnd = (e) => {
            if (!isDragging) return;

            if (dragStarted && currentHoverButton) {
                // Switch to the button we released on
                switchToVideo(currentHoverButton);
            } else if (!dragStarted) {
                // It was just a click - find which button was clicked
                const target = e.target.closest('.control-btn');
                if (target) {
                    switchToVideo(target);
                }
            }

            // Reset text colors
            buttons.forEach((btn) => {
                btn.style.color = '';
            });
            
            isDragging = false;
            dragStarted = false;
            currentHoverButton = null;
        };

        // Attach events to controls container
        controls.addEventListener("mousedown", handleStart);
        controls.addEventListener("touchstart", handleStart, { passive: true });
        
        document.addEventListener("mousemove", handleMove);
        document.addEventListener("touchmove", handleMove, { passive: false });
        
        document.addEventListener("mouseup", handleEnd);
        document.addEventListener("touchend", handleEnd);

        // Initial Layout
        const initialActive = container.querySelector(".control-btn.active");
        if (initialActive) {
            setTimeout(() => movePillTo(initialActive), 50);
        }

        // Resize Handler
        window.addEventListener("resize", () => {
            const active = container.querySelector(".control-btn.active");
            if (active) movePillTo(active);
        });
    };

    // Run immediately if DOM is ready, otherwise wait
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initVideoSwitcher);
    } else {
        initVideoSwitcher();
    }

    // Also re-run on Astro page load if View Transitions are used
    document.addEventListener("astro:page-load", initVideoSwitcher);
</script>
