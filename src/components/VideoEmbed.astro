---
interface Props {
    id: string;
    type: "vimeo" | "youtube";
    title?: string;
    description?: string;
    constrain?: boolean;
}

const {
    id,
    type,
    title = "Video",
    description,
    constrain = true,
} = Astro.props;

let embedUrl = "";
let videoWidth = 16;
let videoHeight = 9;

if (type === "vimeo") {
    const match = id.match(/\d+/);
    const videoId = match ? match[0] : id;
    embedUrl = `https://player.vimeo.com/video/${videoId}?badge=0&autopause=0&player_id=0&app_id=58479`;

    // Fetch native dimensions from Vimeo oEmbed API at build time
    try {
        const res = await fetch(
            `https://vimeo.com/api/oembed.json?url=https://vimeo.com/${videoId}`,
        );
        if (res.ok) {
            const data = await res.json();
            if (data.width && data.height) {
                videoWidth = data.width;
                videoHeight = data.height;
            }
        }
    } catch (e) {
        // Fall back to 16:9 default
    }
} else if (type === "youtube") {
    embedUrl = `https://www.youtube.com/embed/${id}`;
}
---

<figure class:list={["video-embed", { constrained: constrain }]}>
    <div
        class="video-container"
        style={`aspect-ratio: ${videoWidth} / ${videoHeight};`}
    >
        <iframe
            src={embedUrl}
            allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media"
            title={title}
            loading="lazy"></iframe>
    </div>
    {description && <figcaption>{description}</figcaption>}
</figure>

<style>
    .video-embed {
        width: 100%;
        margin-top: 4rem;
        margin-bottom: 2rem;
        box-sizing: border-box;
    }

    .video-embed.constrained {
        /* Constrain to 900px body width */
        padding-inline: max(0rem, calc(50% - 450px));
    }

    .video-container {
        width: 100%;
        overflow: hidden;
        border-radius: var(--radius-md);
        background: var(--surface-secondary);
    }

    .video-container iframe {
        display: block;
        width: 100%;
        height: 100%;
        border: none;
    }

    figcaption {
        text-align: center;
        font-size: 0.875rem;
        color: var(--text-tertiary);
        margin-top: 0.75rem;
    }
</style>
