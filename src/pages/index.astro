---
import Layout from "../layouts/Layout.astro";
import CategorySection from "../components/CategorySection.astro";
import ProjectCard from "../components/ProjectCard.astro";
import CategoryFilter from "../components/CategoryFilter.astro";
import SidebarNavigation from "../components/SidebarNavigation.astro";
import ThemeToggle from "../components/ThemeToggle.astro";
import ContactSection from "../components/ContactSection.astro";
import { getCollection } from "astro:content";

// Fetch all projects
const allProjects = await getCollection("projects");

// Filter projects by category
const thinkingProjects = allProjects
	.filter((p) => p.data.category === "thinking")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const embodiedProjects = allProjects
	.filter((p) => p.data.category === "embodied")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const spatialProjects = allProjects
	.filter((p) => p.data.category === "spatial")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const strategyProjects = allProjects
	.filter((p) => p.data.category === "strategy")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
---

<Layout
	title="Narayan Ashanahalli"
	description="Hi! I’m a graduate student at CMU HCI & SoA. I work at the intersection of sensing, computing, and IxD to create playful, intentional experiences between human -human and human - AI interactions"
>
	<div slot="sidebar" class="home-sidebar">
		<SidebarNavigation isHome={true} />
		<div class="sidebar-controls">
			<ThemeToggle />
			<!-- Socials -->
			<div class="social-group">
				<a
					href="https://linkedin.com/in/narayan-ashanahalli/"
					target="_blank"
					class="social-link"
				>
					<img
						src="/logos/linkedIn-light.png"
						class="s-icon icon-light"
						alt="LinkedIn"
					/>
					<img
						src="/logos/linkedIn-dark.png"
						class="s-icon icon-dark"
						alt="LinkedIn"
					/>
				</a>
				<a
					href="https://www.instagram.com/narayan.3dm/"
					target="_blank"
					class="social-link"
				>
					<img
						src="/logos/instagram-light.png"
						class="s-icon icon-light"
						alt="Instagram"
					/>
					<img
						src="/logos/instagram-dark.png"
						class="s-icon icon-dark"
						alt="Instagram"
					/>
				</a>
				<a
					href="https://github.com/narayan-works"
					target="_blank"
					class="social-link"
				>
					<img
						src="/logos/github-light.png"
						class="s-icon icon-light"
						alt="GitHub"
					/>
					<img
						src="/logos/github-dark.png"
						class="s-icon icon-dark"
						alt="GitHub"
					/>
				</a>
			</div>
		</div>
	</div>

	<div class="home-content">
		<!-- LAYER 1: HERO / INTRO -->
		<section class="hero" id="about">
			<div class="hero-container">
				<div class="bio-content">
					<div class="hero-headline bio-short">
						I’m Narayan, a Product Designer and graduate student at
						Carnegie Mellon University focused on building playful
						human-human and human-machine interactions. With a
						foundation in architecture, I use <span
							class="highlight"
							><span class="u-item">systems thinking</span></span
						> and <span class="highlight"
							><span class="u-item">rapid prototyping</span></span
						> to create digital products that feel responsive, intentional and are grounded
						in existing ecosystems.
					</div>
					<div class="hero-headline bio-long">
						<div class="bio-text">
							Hi, I’m Narayan, a designer interested in building
							playful human-human & human-machine interactions.
							I’m a graduate student at the School of Architecture
							at Carnegie Mellon University and currently work as
							a design researcher with the CMU Human-Computer
							Interaction Institute. Coming from an architecture
							background, my way of working is rooted in thinking
							through systems, scale, and how parts connect.
							Across the different tools and mediums I’ve
							explored, the core question stays the same: how do
							people interact today, and how can we design these
							interactions to be fun and useful. At CMU, I’ve
							explored these questions using computational tools,
							including machine learning, physical computing, and
							AI prototyping. I primarily work through
							prototyping, building early versions, and iterating
							through testing, with the goal of fitting these
							ideas into everyday human activity.
						</div>
					</div>
				</div>
				<div class="hero-actions">
					<a
						href="https://drive.google.com/file/d/1z9FwSv_cy2_RxAijZzFVZaNBnRlbI5rQ/view?usp=sharing"
						target="_blank"
						class="action-link">CV</a
					>
					<button id="read-more-btn" class="action-link read-more">
						Read more
						<svg
							width="12"
							height="12"
							viewBox="0 0 12 12"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
							class="chevron"
						>
							<path
								d="M2.5 4.5L6 8L9.5 4.5"
								stroke="currentColor"
								stroke-width="1.5"
								stroke-linecap="round"
								stroke-linejoin="round"></path>
						</svg>
					</button>
				</div>
			</div>
		</section>

		<!-- LAYER 2: WORKS -->
		<section id="works" class="layer-works">
			<!-- Sticky Filter Header -->
			<div class="works-header-sticky">
				<CategoryFilter />
			</div>

			<!-- Projects Grid -->
			<!-- 1. Tools for Thinking -->
			<CategorySection
				title="Tools for Thinking"
				description="Software that helps people organize complex data and workflows."
				id="thinking"
				id="thinking"
			>
				{
					thinkingProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 2. Spatial Interactions -->
			<CategorySection
				title="Spatial Interactions"
				description="Bridging the digital layer with the physical world."
				id="spatial"
				id="spatial"
			>
				{
					spatialProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 3. Tangible Interactions -->
			<CategorySection
				title="Tangible Interactions"
				description="Giving technology a physical, emotional presence."
				id="embodied"
				id="embodied"
			>
				{
					embodiedProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 4. Design Strategy -->
			<CategorySection
				title="Design Strategy"
				description="Strategic systems at scale, from pixels to campuses."
				id="strategy"
				id="strategy"
			>
				{
					strategyProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>
		</section>

		<!-- LAYER 3: CONTACT -->
		<ContactSection />
	</div>
</Layout>

<style>
	/* Sidebar Styles */
	.home-sidebar {
		height: 100%;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}

	/* Content Area Styles */
	.home-content {
		padding: var(--space-2xl) var(--space-xl);
		max-width: 1200px;
		margin: 0 auto;
		width: 100%;
	}

	/* Hero Section */
	.hero {
		padding: 5rem 0 3rem; /* Adjusted padding for line placement */
		font-weight: 400;
		font-size: 32px;
		border-bottom: 1px solid var(--border-subtle); /* Hero Separator */
		margin-bottom: 36px; /* Gap below line */
	}

	.hero-intro {
		font-size: 1.25rem;
		color: var(--text-secondary);
		max-width: 600px;
		line-height: 1.1;
	}

	/* Works Layer */
	.layer-works {
		position: relative;
		min-height: 100vh;
		background: var(
			--bg-primary
		); /* Ensure opaque background for layering */
		padding-bottom: var(--space-4xl);
		scroll-margin-top: 0; /* Ensure flush alignment with viewport top */
		border-bottom: 1px solid var(--border-subtle); /* Works Separator */
	}

	.works-header-sticky {
		position: sticky;
		top: 0;
		z-index: 5;
		padding: 0; /* Remove padding to be precise */
		margin-bottom: 36px; /* 36px gap to content */
		pointer-events: none; /* Let clicks pass through the empty areas */
	}

	@media (max-width: 1024px) {
		.works-header-sticky {
			top: 5rem !important; /* 80px: Force clear fixed nav (Tablet) */
		}
	}

	@media (max-width: 768px) {
		.works-header-sticky {
			top: 5rem !important; /* 80px: Force clear fixed nav (Mobile) */
		}
	}

	/* Renable pointer events for the filter itself */
	.works-header-sticky :global(*) {
		pointer-events: auto;
	}

	.categories-wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--space-4xl);
	}

	/* Tablet View */
	@media (max-width: 1024px) {
		.home-content {
			padding: 20px;
		}
	}

	@media (max-width: 768px) {
		.hero-bio {
			font-size: 32px;
		}
		.home-content {
			padding: 20px;
		}
	}

	/* Hero Headline Styles */
	.hero-headline {
		text-align: left;
		max-width: 100%;
		font-weight: 500;
		letter-spacing: 0em;
		color: var(--text-secondary); /* Darker Grey base */
	}

	.bio-content {
		position: relative;
		transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
		overflow: hidden;
	}

	.bio-short {
		width: 100%;
		font-size: 32px;
		line-height: 1.1;
		display: block; /* Default visible */
	}

	.bio-short .highlight {
		color: #e5e5e5;
	}

	/* Light Mode Override (Granular Underline) */
	:global([data-theme="light"]) .bio-short .highlight .u-item {
		text-decoration: underline;
		text-underline-offset: 4px;
		text-decoration-color: rgba(0, 0, 0, 0.4);
	}

	/* The parent highlight still controls color */
	:global([data-theme="light"]) .bio-short .highlight {
		color: var(--text-highlight);
	}

	.bio-long {
		width: 100%;
		display: none; /* Default hidden */
		opacity: 0;
		transition: opacity 0.4s ease;

		/* Grid Alignment Layout */
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 1.25rem;
	}

	/* When active, we set display: grid in JS, not block */

	.bio-text {
		grid-column: 1 / 3; /* Spans first two columns */
		font-size: 16px;
		line-height: 1.4;
		color: var(--text-secondary);
	}

	@media (max-width: 650px) {
		/* Collapse to single column on mobile */
		.bio-text {
			grid-column: 1 / -1;
		}
	}

	@media (max-width: 1024px) {
		/* Mobile Sidebar Adjustments */
		.home-sidebar {
			height: auto;
			display: block;
		}

		.sidebar-controls {
			position: fixed;
			bottom: var(--space-md);
			left: var(--space-md);
			z-index: 90;
			display: flex;
			align-items: center;
			gap: 0.5rem;
			background: var(--bg-surface);
			padding: 0.5rem;
			border-radius: 1rem;
			border: 1px solid var(--border-subtle);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			width: fit-content;
		}
	}

	/* Sidebar Controls (Socials + Toggle) */
	.sidebar-controls {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	@media (min-width: 1025px) {
		.sidebar-controls {
			margin-top: auto;
			padding-top: var(--space-lg);
		}
	}

	.social-group {
		display: flex;
		gap: 0.8rem;
		align-items: center;
		padding: 0.5rem 0.75rem;
		border: 1px solid var(--border-subtle);
		border-radius: var(--radius-md);
		background: transparent;
	}

	.social-link {
		display: flex;
		align-items: center;
		opacity: 0.5;
		transition: all 0.2s ease;
	}
	.social-link:hover {
		opacity: 1;
		transform: translateY(-2px);
	}

	.s-icon {
		width: 18px;
		height: 18px;
		object-fit: contain;
	}

	/* Icon Theme Logic */
	/* Dark Mode (Default) -> Show Dark Icon (Light Colored) */
	.icon-light {
		display: none;
	}
	.icon-dark {
		display: block;
	}

	/* Light Mode -> Show Light Icon (Dark Colored) */
	:global([data-theme="light"]) .icon-light {
		display: block;
	}
	:global([data-theme="light"]) .icon-dark {
		display: none;
	}

	@media (min-width: 1025px) {
		.sidebar-controls {
			width: 100%;
			justify-content: space-between;
		}
	}

	/* Hero Actions (Links) */
	.hero-actions {
		display: flex;
		justify-content: flex-start;
		gap: 1.5rem; /* Increased gap for text links */
		margin-top: 1rem;
	}

	.action-link {
		color: var(--text-secondary);
		font-size: 0.95rem; /* Slightly larger text */
		text-decoration: none;
		position: relative;
		background: none;
		border: none;
		padding: 0;
		cursor: pointer;
		font-family: inherit;
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		transition: color 0.2s ease;
	}

	.action-link:hover {
		color: var(--accent-secondary);
	}

	/* Underline Animation */
	.action-link::after {
		content: "";
		position: absolute;
		bottom: -2px;
		left: 0;
		width: 100%;
		height: 1px;
		background-color: var(--accent-secondary);
		transform: scaleX(0);
		transform-origin: right;
		transition: transform 0.3s ease;
	}

	.action-link:hover::after {
		transform: scaleX(1);
		transform-origin: left;
	}

	/* Chevron Animation */
	.chevron {
		transition: transform 0.3s ease;
	}

	.read-more.active .chevron {
		transform: rotate(180deg);
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const readMoreBtn = document.getElementById("read-more-btn");
		const navAbout = document.getElementById("nav-about");
		const bioContent = document.querySelector(
			".bio-content",
		) as HTMLElement;
		const bioShort = document.querySelector(".bio-short") as HTMLElement;
		const bioLong = document.querySelector(".bio-long") as HTMLElement;

		if (readMoreBtn && bioContent && bioShort && bioLong) {
			const toggleBio = () => {
				readMoreBtn.classList.toggle("active");

				const isShortVisible =
					getComputedStyle(bioShort).display !== "none";

				// 1. Lock Container Height (Current State)
				const startHeight = bioContent.offsetHeight;
				bioContent.style.height = `${startHeight}px`;

				if (isShortVisible) {
					// EXPANDING: Short -> Long

					// Instant Disappear Short
					bioShort.style.display = "none";

					// Prepare Long (Grid)
					bioLong.style.display = "grid";
					bioLong.style.opacity = "0";

					// Measure Target Height
					// Unset container height temporarily to measure
					bioContent.style.height = "auto";
					const targetHeight = bioContent.scrollHeight;
					// Reset to start
					bioContent.style.height = `${startHeight}px`;

					// Force Reflow
					void bioContent.offsetWidth;

					// Animate
					bioContent.style.height = `${targetHeight}px`;
					bioLong.style.opacity = "1";
				} else {
					// COLLAPSING: Long -> Short

					// Instant Disappear Long
					bioLong.style.display = "none";
					bioLong.style.opacity = "0";

					// Prepare Short
					bioShort.style.display = "block";

					// Measure Target Height
					bioContent.style.height = "auto";
					const targetHeight = bioContent.scrollHeight;
					bioContent.style.height = `${startHeight}px`;

					// Force Reflow
					void bioContent.offsetWidth;

					// Animate
					bioContent.style.height = `${targetHeight}px`;
				}

				// Cleanup after transition
				setTimeout(() => {
					bioContent.style.height = "auto";
				}, 400);
			};

			// Read More Button Click
			readMoreBtn.addEventListener("click", toggleBio);

			// Auto-Expand if URL has #about hash (on page load)
			if (window.location.hash === "#about") {
				if (!readMoreBtn.classList.contains("active")) {
					// Delay slightly to ensure DOM is ready
					setTimeout(() => {
						toggleBio();
					}, 100);
				}
			}

			// About Link Click - Use Native Redirect
			let isNavigatingToAbout = false; // Flag to prevent auto-collapse during navigation

			if (navAbout) {
				navAbout.addEventListener("click", (e) => {
					e.preventDefault();

					// Set flag to prevent auto-collapse
					isNavigatingToAbout = true;

					// 1. Expand Bio FIRST (before navigation)
					if (
						readMoreBtn &&
						!readMoreBtn.classList.contains("active")
					) {
						toggleBio();
					}

					// 2. Force Native Navigation (Hard Redirect)
					// This uses the browser's anchor behavior to jump to #about
					window.location.href = "/#about";
				});
			}
			// Auto-Collapse Logic (Silent with Scroll Compensation)
			window.addEventListener(
				"scroll",
				() => {
					const worksSection = document.getElementById("works");

					// Only run if Expanded AND Works section exists AND not navigating to About
					if (
						readMoreBtn.classList.contains("active") &&
						worksSection &&
						!isNavigatingToAbout
					) {
						const worksTop = worksSection.offsetTop;
						const scrollY = window.scrollY;

						// Check if we have scrolled into Works (with a small buffer)
						// If we are past the point where Works starts ...
						if (scrollY > worksTop - 100) {
							// 1. Measure Height Before
							const heightBefore = bioContent.offsetHeight;

							// 2. Collapse (Toggle State Logic - Manual Silent)
							bioContent.style.transition = "none"; // Disable animation

							readMoreBtn.classList.remove("active");
							readMoreBtn.innerText = "Read more"; // Reset text

							// Switch Content
							bioLong.style.display = "none";
							bioLong.style.opacity = "0";
							bioShort.style.display = "block";

							// Reset Height
							bioContent.style.height = "auto";

							// 3. Measure Height After
							// Force layout update to get new height
							void bioContent.offsetHeight;
							const heightAfter = bioContent.offsetHeight;
							const diff = heightBefore - heightAfter;

							// 4. Scroll Compensation (The "No Jump" Magic)
							// We subtract the difference to keep the viewport relative to Works

							// DISABLE SMOOTH SCROLLING globally to prevent glitch
							document.documentElement.style.scrollBehavior =
								"auto";

							// Instant Jump
							window.scrollTo(0, window.scrollY - diff);

							// 5. Cleanup
							requestAnimationFrame(() => {
								document.documentElement.style.scrollBehavior =
									"";
								bioContent.style.transition = "";
							});
						}
					}
				},
				{ passive: true },
			);
		}
	});
</script>
