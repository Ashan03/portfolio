---
import Layout from "../layouts/Layout.astro";
import CategorySection from "../components/CategorySection.astro";
import ProjectCard from "../components/ProjectCard.astro";
import CategoryFilter from "../components/CategoryFilter.astro";
import SidebarNavigation from "../components/SidebarNavigation.astro";
import ThemeToggle from "../components/ThemeToggle.astro";
import SocialLinks from "../components/SocialLinks.astro";
import Footer from "../components/Footer.astro";
import GhostRunner from "../components/GhostRunner.astro";
import { getCollection } from "astro:content";

// Fetch all projects
const allProjects = await getCollection("projects");

// Filter projects by category
const thinkingProjects = allProjects
	.filter((p) => p.data.category === "thinking")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const embodiedProjects = allProjects
	.filter((p) => p.data.category === "embodied")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const spatialProjects = allProjects
	.filter((p) => p.data.category === "spatial")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const strategyProjects = allProjects
	.filter((p) => p.data.category === "strategy")
	.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
---

<Layout
	title="Narayan Ashanahalli"
	description="Hi! I’m a graduate student at CMU HCI & SoA. I work at the intersection of sensing, computing, and IxD to create playful, intentional experiences between human -human and human - AI interactions"
>
	<div slot="sidebar" class="home-sidebar">
		<SidebarNavigation isHome={true} />
		<div class="sidebar-controls">
			<ThemeToggle />
			<SocialLinks />
		</div>
	</div>

	<div class="home-content">
		<!-- LAYER 1: HERO / INTRO -->
		<section class="hero" id="about">
			<div class="hero-container">
				<!-- Game inserted above bio -->
				<GhostRunner />
				<div class="bio-content">
					<div class="hero-headline bio-short">
						I’m Narayan, a Product Designer and graduate student at
						Carnegie Mellon University focused on building playful
						human-human and human-machine interactions. With a
						foundation in architecture, I use <span
							class="highlight"
							><span class="u-item">systems thinking</span></span
						> and <span class="highlight"
							><span class="u-item">rapid prototyping</span></span
						> to create digital products that feel responsive, intentional
						and are grounded in existing ecosystems.
					</div>
					<div class="hero-headline bio-long">
						<div class="bio-text">
							Hi, I’m Narayan, a designer interested in building
							playful human-human & human-machine interactions.
							I’m a graduate student at the School of Architecture
							at Carnegie Mellon University and currently work as
							a design researcher with the CMU Human-Computer
							Interaction Institute. Coming from an architecture
							background, my way of working is rooted in thinking
							through systems, scale, and how parts connect.
							Across the different tools and mediums I’ve
							explored, the core question stays the same: how do
							people interact today, and how can we design these
							interactions to be fun and useful. At CMU, I’ve
							explored these questions using computational tools,
							including machine learning, physical computing, and
							AI prototyping. I primarily work through
							prototyping, building early versions, and iterating
							through testing, with the goal of fitting these
							ideas into everyday human activity.
						</div>
					</div>
				</div>
				<div class="hero-actions">
					<a
						href="https://drive.google.com/file/d/1z9FwSv_cy2_RxAijZzFVZaNBnRlbI5rQ/view?usp=sharing"
						target="_blank"
						class="action-link">CV</a
					>
					<button id="read-more-btn" class="action-link read-more">
						Read more
						<svg
							width="12"
							height="12"
							viewBox="0 0 12 12"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
							class="chevron"
						>
							<path
								d="M2.5 4.5L6 8L9.5 4.5"
								stroke="currentColor"
								stroke-width="1.5"
								stroke-linecap="round"
								stroke-linejoin="round"></path>
						</svg>
					</button>
				</div>
			</div>
		</section>

		<!-- LAYER 2: WORKS -->
		<section id="works" class="layer-works">
			<!-- Sticky Filter Header -->
			<div class="works-header-sticky">
				<CategoryFilter />
			</div>

			<!-- Projects Grid -->
			<!-- 1. Tools for Thinking -->
			<CategorySection
				title="Tools for Thinking"
				description="Software that helps people organize complex data and workflows."
				id="thinking"
				id="thinking"
			>
				{
					thinkingProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 2. Spatial Interactions -->
			<CategorySection
				title="Spatial Interactions"
				description="Bridging the digital layer with the physical world."
				id="spatial"
				id="spatial"
			>
				{
					spatialProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 3. Tangible Interactions -->
			<CategorySection
				title="Tangible Interactions"
				description="Giving technology a physical, emotional presence."
				id="embodied"
				id="embodied"
			>
				{
					embodiedProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>

			<!-- 4. Design Strategy -->
			<CategorySection
				title="Design Strategy"
				description="Strategic systems at scale, from pixels to campuses."
				id="strategy"
				id="strategy"
			>
				{
					strategyProjects.map((project) => (
						<ProjectCard
							title={project.data.title}
							description={project.data.description}
							tags={project.data.tags}
							href={`/works/${project.slug}`}
							image={project.data.heroImage}
						/>
					))
				}
			</CategorySection>
		</section>

		<Footer />
	</div>
</Layout>

<style>
	/* Sidebar Styles */
	.home-sidebar {
		height: 100%;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}

	/* Content Area Styles */
	.home-content {
		padding: 20px var(--space-xl) 20px; /* Top 20px, Sides XL, Bottom 20px */
		max-width: 1200px;
		margin: 0 auto;
		width: 100%;
	}

	/* Hero Section */
	.hero {
		padding: 0 0 3rem; /* EXACTLY 20px top padding as requested */
		font-weight: 400;
		font-size: 32px;
		border-bottom: 1px solid var(--border-subtle); /* Hero Separator */
		margin-bottom: 36px; /* Gap below line */
	}

	.hero-intro {
		font-size: 1.25rem;
		color: var(--text-secondary);
		max-width: 600px;
		line-height: 1.1;
	}

	/* Works Layer */
	.layer-works {
		position: relative;
		min-height: 100vh;
		background: var(
			--bg-primary
		); /* Ensure opaque background for layering */
		padding-bottom: var(--space-4xl);
		scroll-margin-top: 0; /* Ensure flush alignment with viewport top */
	}

	.works-header-sticky {
		position: sticky;
		top: 0;
		z-index: 5;
		padding: 0; /* Remove padding to be precise */
		margin-bottom: 36px; /* 36px gap to content */
		pointer-events: none; /* Let clicks pass through the empty areas */
	}

	@media (max-width: 1024px) {
		.works-header-sticky {
			top: 5rem !important; /* 80px: Force clear fixed nav (Tablet) */
		}
	}

	@media (max-width: 768px) {
		.works-header-sticky {
			top: 5rem !important; /* 80px: Force clear fixed nav (Mobile) */
		}
	}

	/* Renable pointer events for the filter itself */
	.works-header-sticky :global(*) {
		pointer-events: auto;
	}

	.categories-wrapper {
		display: flex;
		flex-direction: column;
		gap: var(--space-4xl);
	}

	/* Tablet View */
	@media (max-width: 1024px) {
		.home-content {
			padding: 20px 20px 40px 20px;
		}
	}

	@media (max-width: 768px) {
		.hero-bio {
			font-size: 32px;
		}
		.home-content {
			padding: 20px 20px 40px 20px;
		}
	}

	/* Hero Headline Styles */
	.hero-headline {
		text-align: left;
		max-width: 100%;
		font-weight: 500;
		letter-spacing: 0em;
		color: var(--text-secondary); /* Darker Grey base */
	}

	.bio-content {
		position: relative;
		transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
		overflow: hidden;
	}

	.bio-short {
		width: 100%;
		font-size: 32px;
		line-height: 1.1;
		display: block; /* Default visible */
	}

	.bio-short .highlight {
		color: #e5e5e5;
	}

	/* Light Mode Override (Granular Underline) */
	:global([data-theme="light"]) .bio-short .highlight .u-item {
		text-decoration: underline;
		text-underline-offset: 4px;
		text-decoration-color: rgba(0, 0, 0, 0.4);
	}

	/* The parent highlight still controls color */
	:global([data-theme="light"]) .bio-short .highlight {
		color: var(--text-highlight);
	}

	.bio-long {
		width: 100%;
		display: none; /* Default hidden */
		opacity: 0;
		transition: opacity 0.4s ease;

		/* Grid Alignment Layout */
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 1.25rem;
	}

	/* When active, we set display: grid in JS, not block */

	.bio-text {
		grid-column: 1 / 3; /* Spans first two columns */
		font-size: 16px;
		line-height: 1.4;
		color: var(--text-secondary);
	}

	@media (max-width: 650px) {
		/* Collapse to single column on mobile */
		.bio-text {
			grid-column: 1 / -1;
		}
	}

	@media (max-width: 1024px) {
		/* Mobile Sidebar Adjustments */
		.home-sidebar {
			height: auto;
			display: block;
		}

		.sidebar-controls {
			position: fixed;
			bottom: 20px;
			left: 20px;
			z-index: 90;
			display: flex;
			align-items: center;
			gap: 0; /* Remove gap, we'll use padding/margins if needed */
			background: var(--bg-surface);
			padding: 0.5rem 0.75rem; /* Match bento padding */
			border-radius: var(--radius-md);
			border: 1px solid var(--border-subtle);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			width: fit-content;
			transition: bottom 0.1s ease-out; /* Smooth docking */
		}

		/* Style children to look like one unified component */
		.sidebar-controls :global(#theme-toggle) {
			border: none;
			background: transparent;
			padding: 0 0.5rem 0 0; /* Right padding for spacing */
			border-radius: 0;
			border-right: 1px solid var(--border-subtle); /* Divider */
			height: 24px; /* Fix height for alignment */
			margin-right: 0.5rem;
		}

		.sidebar-controls :global(.social-group) {
			border: none;
			background: transparent;
			padding: 0;
			gap: 0.5rem;
		}
	}

	/* Sidebar Controls (Socials + Toggle) */
	.sidebar-controls {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	@media (min-width: 1025px) {
		.sidebar-controls {
			margin-top: auto;
			padding-top: var(--space-lg);
		}
	}

	@media (min-width: 1025px) {
		.sidebar-controls {
			width: 100%;
			justify-content: space-between;
		}
	}

	/* Hero Actions (Links) */
	.hero-actions {
		display: flex;
		justify-content: flex-start;
		gap: 1.5rem; /* Increased gap for text links */
		margin-top: 1rem;
	}

	.action-link {
		color: var(--text-secondary);
		font-size: 0.95rem; /* Slightly larger text */
		text-decoration: none;
		position: relative;
		background: none;
		border: none;
		padding: 0;
		cursor: pointer;
		font-family: inherit;
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		transition: color 0.2s ease;
	}

	.action-link:hover {
		color: var(--accent-secondary);
	}

	/* Underline Animation */
	.action-link::after {
		content: "";
		position: absolute;
		bottom: -2px;
		left: 0;
		width: 100%;
		height: 1px;
		background-color: var(--accent-secondary);
		transform: scaleX(0);
		transform-origin: right;
		transition: transform 0.3s ease;
	}

	.action-link:hover::after {
		transform: scaleX(1);
		transform-origin: left;
	}

	/* Chevron Animation */
	.chevron {
		transition: transform 0.3s ease;
	}

	.read-more.active .chevron {
		transform: rotate(180deg);
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const readMoreBtn = document.getElementById("read-more-btn");
		const navAbout = document.getElementById("nav-about");
		const bioContent = document.querySelector(
			".bio-content",
		) as HTMLElement;
		const bioShort = document.querySelector(".bio-short") as HTMLElement;
		const bioLong = document.querySelector(".bio-long") as HTMLElement;

		if (readMoreBtn && bioContent && bioShort && bioLong) {
			const toggleBio = () => {
				readMoreBtn.classList.toggle("active");

				const isShortVisible =
					getComputedStyle(bioShort).display !== "none";

				// 1. Lock Container Height (Current State)
				const startHeight = bioContent.offsetHeight;
				bioContent.style.height = `${startHeight}px`;

				if (isShortVisible) {
					// EXPANDING: Short -> Long

					// Instant Disappear Short
					bioShort.style.display = "none";

					// Prepare Long (Grid)
					bioLong.style.display = "grid";
					bioLong.style.opacity = "0";

					// Measure Target Height
					// Unset container height temporarily to measure
					bioContent.style.height = "auto";
					const targetHeight = bioContent.scrollHeight;
					// Reset to start
					bioContent.style.height = `${startHeight}px`;

					// Force Reflow
					void bioContent.offsetWidth;

					// Animate
					bioContent.style.height = `${targetHeight}px`;
					bioLong.style.opacity = "1";
				} else {
					// COLLAPSING: Long -> Short

					// Instant Disappear Long
					bioLong.style.display = "none";
					bioLong.style.opacity = "0";

					// Prepare Short
					bioShort.style.display = "block";

					// Measure Target Height
					bioContent.style.height = "auto";
					const targetHeight = bioContent.scrollHeight;
					bioContent.style.height = `${startHeight}px`;

					// Force Reflow
					void bioContent.offsetWidth;

					// Animate
					bioContent.style.height = `${targetHeight}px`;
				}

				// Cleanup after transition
				setTimeout(() => {
					bioContent.style.height = "auto";
				}, 400);
			};

			// Read More Button Click
			readMoreBtn.addEventListener("click", toggleBio);

			// Auto-Expand if URL has #about hash (on page load)
			if (window.location.hash === "#about") {
				if (!readMoreBtn.classList.contains("active")) {
					// Delay slightly to ensure DOM is ready
					setTimeout(() => {
						toggleBio();
					}, 100);
				}
			}

			// About Link Click - Use Native Redirect
			let isNavigatingToAbout = false; // Flag to prevent auto-collapse during navigation

			if (navAbout) {
				navAbout.addEventListener("click", (e) => {
					e.preventDefault();

					// Set flag to prevent auto-collapse
					isNavigatingToAbout = true;

					// 1. Expand Bio FIRST (before navigation)
					if (
						readMoreBtn &&
						!readMoreBtn.classList.contains("active")
					) {
						toggleBio();
					}

					// 2. Force Native Navigation (Hard Redirect)
					// This uses the browser's anchor behavior to jump to #about
					window.location.href = "/#about";
				});
			}
			// Auto-Collapse Logic (Silent with Scroll Compensation)
			window.addEventListener(
				"scroll",
				() => {
					const worksSection = document.getElementById("works");

					// Only run if Expanded AND Works section exists AND not navigating to About
					if (
						readMoreBtn.classList.contains("active") &&
						worksSection &&
						!isNavigatingToAbout
					) {
						const worksTop = worksSection.offsetTop;
						const scrollY = window.scrollY;

						// Check if we have scrolled into Works (with a small buffer)
						// If we are past the point where Works starts ...
						if (scrollY > worksTop - 100) {
							// 1. Measure Height Before
							const heightBefore = bioContent.offsetHeight;

							// 2. Collapse (Toggle State Logic - Manual Silent)
							bioContent.style.transition = "none"; // Disable animation

							readMoreBtn.classList.remove("active");
							readMoreBtn.innerText = "Read more"; // Reset text

							// Switch Content
							bioLong.style.display = "none";
							bioLong.style.opacity = "0";
							bioShort.style.display = "block";

							// Reset Height
							bioContent.style.height = "auto";

							// 3. Measure Height After
							// Force layout update to get new height
							void bioContent.offsetHeight;
							const heightAfter = bioContent.offsetHeight;
							const diff = heightBefore - heightAfter;

							// 4. Scroll Compensation (The "No Jump" Magic)
							// We subtract the difference to keep the viewport relative to Works

							// DISABLE SMOOTH SCROLLING globally to prevent glitch
							document.documentElement.style.scrollBehavior =
								"auto";

							// Instant Jump
							window.scrollTo(0, window.scrollY - diff);

							// 5. Cleanup
							requestAnimationFrame(() => {
								document.documentElement.style.scrollBehavior =
									"";
								bioContent.style.transition = "";
							});
						}
					}
				},
				{ passive: true },
			);
		}
	});
</script>

<script>
	// Mobile sidebar controls docking behavior
	function updateControlsPosition() {
		// Only run on mobile/tablet (roughly check media query or just let it run if sidebar-controls is visible)
		// Better to check if the element has fixed positioning or use media query
		if (window.matchMedia("(min-width: 1025px)").matches) {
			const controls = document.querySelector(
				".sidebar-controls",
			) as HTMLElement;
			if (controls) controls.style.bottom = ""; // Reset
			return;
		}

		const controls = document.querySelector(
			".sidebar-controls",
		) as HTMLElement;
		const footerText = document.querySelector(
			".contact-message",
		) as HTMLElement;

		if (!controls || !footerText) return;

		const footerRect = footerText.getBoundingClientRect();
		const windowHeight = window.innerHeight;

		// Base bottom offset matches CSS 20px
		const baseBottom = 20;
		const gap = 20; // Ensure 40px gap above the footer text ("name card")

		// Check if footer text is entering viewport from bottom
		if (footerRect.top < windowHeight) {
			// Calculate new bottom position to stay above the text
			// bottom = (windowHeight - footerTextTop) + gap
			const overlapOffset = windowHeight - footerRect.top;
			const newBottom = Math.max(baseBottom, overlapOffset + gap);
			controls.style.bottom = `${newBottom}px`;
		} else {
			controls.style.bottom = `${baseBottom}px`;
		}
	}

	window.addEventListener("scroll", updateControlsPosition, {
		passive: true,
	});
	window.addEventListener("resize", updateControlsPosition);
	// Initial call
	updateControlsPosition();
</script>

<style is:global>
	/* 240px margin for footer on home page */
	.home-content .site-footer {
		margin-top: 240px !important;
	}
</style>
